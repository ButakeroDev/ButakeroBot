### Configuraci√≥n de EC2 para ButakeroMusicBotGo

ü§ñ **Descripci√≥n:**

El bot de Discord de ButakeroMusicBotGo est√° alojado en Amazon EC2, lo que proporciona un entorno virtual escalable y controlado para ejecutar aplicaciones y servicios.

üîß **Componentes Principales:**

1. **VPC (Virtual Private Cloud)**: La instancia EC2 est√° dentro de una VPC que proporciona una red virtual aislada y segura para el bot. La VPC garantiza un control total sobre la configuraci√≥n de red, incluyendo la asignaci√≥n de direcciones IP, las tablas de enrutamiento y las puertas de enlace de Internet.

2. **Subnet**: La instancia EC2 se encuentra en una o m√°s subredes de la VPC, distribuidas en distintas zonas de disponibilidad (AZs) para garantizar la alta disponibilidad y la tolerancia a fallos.

3. **Security Group**: Un grupo de seguridad est√° asociado a la instancia EC2 y controla el tr√°fico de red entrante y saliente. Se definen reglas de seguridad espec√≠ficas para permitir o denegar el acceso a los puertos necesarios para el funcionamiento del bot.

üõ†Ô∏è **Tecnolog√≠as Utilizadas:**

- **AWS EC2**: Se utiliza para alojar y ejecutar el bot de Discord en un entorno virtual escalable.
- **VPC, Subnet y Security Group**: Se emplean para configurar y asegurar el entorno de red de la instancia EC2.

üîÑ **Flujo de Trabajo:**

1. La instancia EC2 se inicia con una configuraci√≥n espec√≠fica dentro de la VPC y las subredes definidas.
2. Se aplican las reglas de seguridad del grupo de seguridad asociado a la instancia para controlar el tr√°fico de red permitido.
3. El bot de Discord se ejecuta en la instancia EC2 y puede interactuar con otros servicios y recursos de AWS seg√∫n sea necesario.

üîí **Seguridad y Monitoreo:**

- Se aplican pol√≠ticas de seguridad y reglas de seguridad espec√≠ficas para restringir el acceso no autorizado a la instancia EC2.
- Se implementan medidas de monitoreo y registro para supervisar el rendimiento, la disponibilidad y la integridad de la instancia EC2 y sus recursos asociados.
---

### Configuraci√≥n del Webhook de GitHub para ButakeroMusicBotGo

## Diagrama de Arquitectura

![Diagrama de Arquitectura](/images/Arquitectura%20Webhook.png)

**Descripci√≥n:**

ButakeroMusicBotGo utiliza un webhook de GitHub para recibir eventos de nuevas versiones o workflows. Estos eventos son procesados y utilizados para enviar notificaciones a los canales de Discord a trav√©s del bot.

üîß **Componentes Principales:**

1. **API Gateway**: La API Gateway proporciona un punto de entrada seguro para los eventos de GitHub enviados a trav√©s del webhook. La ruta `/github-webhook` est√° configurada para recibir y enrutar estos eventos a una funci√≥n Lambda.

2. **Funciones Lambda**: Una funci√≥n Lambda se activa en respuesta a los eventos de GitHub recibidos a trav√©s de la API Gateway. Esta funci√≥n procesa los eventos y los enruta a diferentes temas de SQS basados en el tipo de evento.

3. **Colas SQS**: Amazon SQS se utiliza para encolar los eventos de GitHub despu√©s de ser procesados por la funci√≥n Lambda. Cada tipo de evento tiene su propio tema SQS para garantizar un procesamiento y enrutamiento eficientes.

üõ†Ô∏è **Tecnolog√≠as Utilizadas:**

- **AWS API Gateway y Lambda**: Se utilizan para recibir, procesar y enrutar los eventos de GitHub a trav√©s del webhook.
- **Amazon SQS**: Se emplea para encolar y distribuir los eventos de GitHub a otras partes del sistema.

üîÑ **Flujo de Trabajo:**

1. GitHub env√≠a eventos de nuevas versiones o workflows a la API Gateway `/github-webhook`.
2. La funci√≥n Lambda asociada a la API Gateway procesa estos eventos y los enruta a los temas SQS correspondientes.
3. Otras funciones Lambda est√°n suscritas a los temas SQS y se activan cuando hay nuevos eventos en las colas. Estas funciones formatean los eventos y los env√≠an a Discord a trav√©s del bot.

üîí **Seguridad y Monitoreo:**

- Se aplican pol√≠ticas de seguridad y reglas de seguridad espec√≠ficas para proteger la API Gateway y las funciones Lambda.
- Se implementan medidas de monitoreo y registro para supervisar el rendimiento, la disponibilidad y la integridad de la API Gateway, las funciones Lambda y las colas SQS.

---

### Flujo de CI/CD para ButakeroMusicBotGo

üõ†Ô∏è **Flujo de Desarrollo de Go**

## Diagrama de Secuencia CI/CD

![Diagrama de Secuencia CI/CD](/images/ci-cd%20d%20secuencia.png)

**Descripci√≥n:**

Este flujo de trabajo automatizado se encarga de compilar, probar y generar un informe de cobertura para el c√≥digo fuente de ButakeroMusicBotGo cada vez que se realizan cambios en los archivos `.go`.

**Componentes Principales:**

- **GitHub Actions**: Se utiliza para ejecutar el flujo de CI/CD autom√°ticamente en respuesta a eventos de push y pull request en la rama `master`.
- **Instalaci√≥n de Dependencias**: Se instalan las dependencias necesarias para compilar el c√≥digo, incluyendo herramientas como `golangci-lint`, `dca`, `yt-dlp`, entre otras.
- **Compilaci√≥n y Pruebas**: Se compila el c√≥digo, se ejecutan las pruebas unitarias y se genera un informe de cobertura para evaluar la calidad del c√≥digo.
- **Subida de Informe de Cobertura**: Se sube el informe de cobertura generado para su revisi√≥n.

**üîÅ Flujo de Entrega Continua de Go**

**Descripci√≥n:**

Este flujo de trabajo automatizado se encarga de desplegar la √∫ltima versi√≥n del bot en un servidor EC2 despu√©s de que se haya completado satisfactoriamente el flujo de desarrollo.

**Componentes Principales:**

- **GitHub Actions**: Se utiliza para ejecutar el flujo de CI/CD autom√°ticamente en respuesta a la finalizaci√≥n exitosa del flujo de desarrollo.
- **Conexi√≥n a AWS**: Se configuran las credenciales de AWS para interactuar con los servicios de EC2.
- **Construcci√≥n y Publicaci√≥n de Im√°genes Docker**: Se construye y publica una nueva imagen Docker con la √∫ltima versi√≥n del bot en Docker Hub.
- **Despliegue a EC2**: Se utiliza SSH para conectarse al servidor EC2 y realizar el despliegue del bot actualizando el c√≥digo y reiniciando los servicios necesarios.
---


### Herramientas de Monitoreo y Perfilado

üìä **Descripci√≥n:**

Adem√°s de la infraestructura y los flujos de CI/CD mencionados anteriormente, agregue herramientas de monitoreo y perfilado para supervisar y optimizar su rendimiento en tiempo real.

**Componentes Principales:**

- **Grafana**: Se utiliza como plataforma de visualizaci√≥n de datos para crear paneles y gr√°ficos que muestran m√©tricas importantes del bot, como el uso de CPU, la memoria, la latencia de red, etc.

- **Prometheus**: Se utiliza como sistema de monitorizaci√≥n y alerta para recopilar y almacenar m√©tricas del bot. Se integra con Grafana para la visualizaci√≥n de datos en tiempo real.

- **Pyroscope**: Se utiliza para el perfilado de la aplicaci√≥n, permitiendo identificar cuellos de botella y optimizar el rendimiento del c√≥digo mediante el an√°lisis de la CPU y el uso de memoria.

**üîç Monitoreo y Optimizaci√≥n Continuos:**

Estas herramientas se utilizan de manera continua para monitorear el rendimiento del bot, identificar posibles problemas y realizar ajustes en la configuraci√≥n y el c√≥digo para garantizar un funcionamiento √≥ptimo y una experiencia de usuario satisfactoria.

**Ejemplos Visuales:**

A continuaci√≥n, se muestran algunas capturas de pantalla de los paneles en Grafana y Pyroscope:

#### Grafana:

![Panel de Grafana 1](/images/paneles.png)
1. **Panel 1: GC duration quantile**
   - **Descripci√≥n:** Muestra la duraci√≥n de los ciclos de recolecci√≥n de basura (GC) en diferentes percentiles.
   - **Explicaci√≥n:** Indica cu√°nto tiempo tarda el recolector de basura en limpiar la memoria. Un aumento en la duraci√≥n del GC puede se√±alar problemas de memoria o de rendimiento.

2. **Panel 2: Memory in Off-Heap**
   - **Descripci√≥n:** Muestra el uso de memoria fuera del mont√≥n (Off-Heap) en diferentes categor√≠as.
   - **Explicaci√≥n:** Muestra el uso de memoria en √°reas de Go que no son parte del mont√≥n principal. Un aumento podr√≠a indicar un uso excesivo de recursos adicionales.

3. **Panel 3: Memory in Stack**
   - **Descripci√≥n:** Muestra el uso de memoria en la pila (Stack) en bytes.
   - **Explicaci√≥n:** Indica cu√°nta memoria se est√° utilizando para almacenar datos locales de funciones, variables, etc. Un aumento podr√≠a indicar operaciones que requieren m√°s memoria.

4. **Panel 4: Memory in Heap**
   - **Descripci√≥n:** Muestra el uso de memoria en el mont√≥n (Heap) en diferentes categor√≠as.
   - **Explicaci√≥n:** Muestra c√≥mo se distribuye la memoria dentro del mont√≥n. Ayuda a identificar si se est√°n asignando demasiados objetos o si hay memoria sin usar.

5. **Panel 5: Total Used Memory**
   - **Descripci√≥n:** Muestra la cantidad total de memoria usada por el bot.
   - **Explicaci√≥n:** Indica la cantidad total de memoria que est√° utilizando el bot. Un aumento puede se√±alar problemas de memoria o de recursos.

6. **Panel 6: N√∫mero de Veces que se Usan los Comandos**
   - **Descripci√≥n:** Muestra el n√∫mero de veces que se ejecuta un comando espec√≠fico (PlaySong).
   - **Explicaci√≥n:** Indica la frecuencia de uso de los comandos, proporcionando informaci√≥n sobre la interacci√≥n de los usuarios con el bot.

#### Pyroscope:

![Captura de Pyroscope](/images/profiling.png)
### Profiling

**Panel Superior:**
- **Descripci√≥n:** Muestra una gr√°fica del conteo total de objetos asignados en memoria a lo largo del tiempo. Los picos altos indican momentos donde se han asignado muchos objetos.
  
**Panel Inferior:**
- **Columna "Symbol":** Muestra el nombre de la funci√≥n o paquete de c√≥digo que ha asignado objetos en memoria.
- **Columna "Self":** Indica cu√°ntos objetos ha asignado directamente la funci√≥n o paquete.
- **Columna "Total":** Muestra el conteo total de objetos asignados por la funci√≥n o paquete, incluyendo los objetos que se asignaron en las funciones que llama.

**Flame Graph:**
- **Descripci√≥n:** Visualizaci√≥n que muestra c√≥mo se llama a las funciones en tu aplicaci√≥n. Cada caja representa una funci√≥n, y el tama√±o es proporcional al n√∫mero de objetos que asigna. Los colores ayudan a identificar diferentes paquetes de c√≥digo.

**Informaci√≥n Extra√≠da:**
- **Punto Caliente:** La funci√≥n `github.com/Tomas-vite/GoMusicBot/internal/music/fetcher.(*YoutubeFetcher).GetDCAData.func1` parece ser la que m√°s objetos asigna en memoria.
- **Llamadas:** El flame graph muestra que esta funci√≥n llama a varias funciones, incluyendo `runtime/pprof.(*profileBuilder).flush` y `github.com/klauspost/compress/zip.(*Writer).Close`.
- **Posibles Problemas:** Funciones relacionadas con la compresi√≥n y la red tambi√©n asignan muchos objetos, lo que podr√≠a indicar un uso excesivo o una fuga de memoria.